# GitLab CI/CD Pipeline for MCP Client

stages:
  - lint
  - unit-test
  - contract-test
  - build
  - helm-package
  - deploy

variables:
  REGISTRY: "registry.gitlab.com"
  IMAGE_NAME: "${REGISTRY}/${CI_PROJECT_NAMESPACE}/mcp-client"
  IMAGE_TAG: "${CI_COMMIT_SHORT_SHA}"
  PYTHON_VERSION: "3.11"
  MCP_SERVER_URL: "http://mcp-server:8000"

# ============================================================================
# Lint Stage
# ============================================================================

lint:pylint:
  stage: lint
  image: python:${PYTHON_VERSION}-slim
  before_script:
    - pip install --no-cache-dir pylint pydantic setuptools
  script:
    - pylint src/ --disable=too-few-public-methods --max-line-length=100
  allow_failure: true

lint:black:
  stage: lint
  image: python:${PYTHON_VERSION}-slim
  before_script:
    - pip install --no-cache-dir black
  script:
    - black --check --line-length 100 src/
  allow_failure: true

# ============================================================================
# Unit Test Stage
# ============================================================================

test:unit:
  stage: unit-test
  image: python:${PYTHON_VERSION}-slim
  before_script:
    - pip install --no-cache-dir -r requirements-dev.txt
  script:
    - pytest tests/ -v --cov=src --cov-report=term-missing --cov-report=xml
  coverage: '/TOTAL.*\s+(\d+%)$/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
    expire_in: 30 days

# ============================================================================
# Contract Test Stage (MANDATORY - CI FAILS IF CONTRACTS BREAK)
# ============================================================================

test:contract:
  stage: contract-test
  image: python:${PYTHON_VERSION}-slim
  services:
    - name: "mcp-server:latest"
      alias: "mcp-server"
  before_script:
    - pip install --no-cache-dir -r requirements-dev.txt
    - sleep 5  # Wait for MCP Server to start
  script:
    - MCP_SERVER_URL=${MCP_SERVER_URL} pytest tests/contract/ -v --tb=short
  on_failure:
    script:
      - echo "CONTRACT TEST FAILED - BLOCKING PIPELINE"
  only:
    - main
    - tags

# ============================================================================
# Build Stage (Docker)
# ============================================================================

build:docker:
  stage: build
  image: docker:24-dind
  services:
    - docker:24-dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - docker build -t ${IMAGE_NAME}:${IMAGE_TAG} -t ${IMAGE_NAME}:latest .
    - docker push ${IMAGE_NAME}:${IMAGE_TAG}
    - docker push ${IMAGE_NAME}:latest
  only:
    - main
    - tags

# ============================================================================
# Helm Package Stage
# ============================================================================

package:helm:
  stage: helm-package
  image: alpine/helm:latest
  script:
    - helm lint helm/mcp-client-chart/
    - helm template mcp-client helm/mcp-client-chart/ > helm-rendered.yaml
    - helm package helm/mcp-client-chart/
  artifacts:
    paths:
      - "*.tgz"
      - helm-rendered.yaml
    expire_in: 30 days
  only:
    - main
    - tags

# ============================================================================
# Deploy Stage (AKS)
# ============================================================================

deploy:aks:
  stage: deploy
  image: alpine/k8s:latest
  before_script:
    - apk add --no-cache helm
    - mkdir -p $HOME/.kube
    - echo "$KUBECONFIG_CONTENT" | base64 -d > $HOME/.kube/config
    - kubectl cluster-info
  script:
    - kubectl create namespace mcp-system --dry-run=client -o yaml | kubectl apply -f -
    - helm upgrade --install mcp-client helm/mcp-client-chart/
        --namespace mcp-system
        --set image.tag=${IMAGE_TAG}
        --set azure.tenantId=${AZURE_TENANT_ID}
        --set azure.clientId=${AZURE_CLIENT_ID}
        --set app.mcpServerUrl=http://mcp-server:8000
        --wait
        --timeout 5m
    - kubectl rollout status deployment/mcp-client -n mcp-system --timeout=5m
  environment:
    name: production
    kubernetes:
      namespace: mcp-system
  only:
    - main
    - tags
  when: manual
